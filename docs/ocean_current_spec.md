

# 海流描画ロジック 実装仕様書

本ドキュメントは、`services/physics/ocean.ts` に実装されている、エージェントベースの海流シミュレーションロジックについて解説します。

このシステムは、流体力学的な厳密解ではなく、**「ITCZ（熱帯収束帯）をアトラクタとするパーティクルシステム」** を用いて、視覚的に説得力のある海流パターンを高速に生成することを目的としています。

## 1. 2段階パス構造 (Two-Pass Architecture)

本アルゴリズムは2つの独立したパスに分割されています。

1.  **Pass 1: 赤道反流 (ECC - Equatorial Counter Current)**
    *   西から東 (+U) へ流れる主要な海流。
    *   ITCZ直下を流れる。
    *   大陸棚に衝突すると、Pass 2のための「発生源」を記録する。
2.  **Pass 2: 赤道海流 (EC - Equatorial Current)**
    *   ECCが大陸に衝突した地点から発生する。
    *   東から西 (-U) へ流れる。
    *   ECCを挟んで南北に分離し、ITCZから一定距離（拡散限界 `oceanDeflectLat` の半分）を保って流れる。

---

## 2. Pass 1: 赤道反流 (ECC)

### 生成と移動
*   **生成**: ITCZライン上の深海からスポーンします。
*   **駆動力**: 常に東向き (+U) の力が加わります。
*   **引力**: ITCZの緯度に向かって強く引き寄せられます。

### 衝突処理と終了
*   **沿岸移動**: 大陸棚（深度 -200m 以浅）に衝突すると、壁沿いにスライド移動します（`bypass` 挙動）。
*   **インパクト検出**: 
    *   エージェントが東向きに進行中、大陸壁面に衝突し、速度が低下または大きく偏向された場合、その地点を **Impact Point** として記録します。
    *   壁によって西向きに跳ね返された場合、そのECCエージェントは消滅します（還流としてECにバトンタッチするため）。

---

## 3. Pass 2: 赤道海流 (EC)

### 生成と分岐
*   Pass 1で記録された全ての Impact Point から、それぞれ2つのエージェントが生成されます。
    *   **北分岐 (North Branch)**: 初期速度として北向きの運動量 (`-oceanEcPolewardDrift`) を持ちます。
    *   **南分岐 (South Branch)**: 初期速度として南向きの運動量 (`+oceanEcPolewardDrift`) を持ちます。

### 移動ルール
*   **駆動力**: 常に西向き (-U) の力が加わります。
*   **ターゲット緯度**: 以下の計算式で決定されるターゲット緯度に向かって引き寄せられます。
    *   `TargetLat = ITCZ ± (oceanDeflectLat / 2)`
    *   すなわち、ECの分離幅は固定定数ではなく、物理パラメータである「拡散限界」に依存して自動計算されます。
*   **引力**: `oceanEcPatternForce` 係数を使用してターゲット緯度へ引き寄せられます。これはECCのITCZ引力係数とは独立して設定可能です。
*   **終了**: 西側の陸地に到達すると消滅します。

### 沿岸這い上がり (Coastal Crawl)
ターゲット緯度から遠く離れ、かつ大陸沿岸部（浅瀬）に位置する場合、西向きの推進力を抑制し、南北方向の移動を優先させる「這い上がり」挙動が適用されます。これにより、海流が斜めにショートカットすることなく、大陸に沿って適切な緯度まで移動してから外洋へ流れる自然な循環が形成されます。

---

## 4. パラメータ

| パラメータ名 | 説明 | 
|:---|:---|
| `oceanBaseSpeed` | 基本流速係数。 |
| `oceanPatternForce` | Pass 1 (ECC) における ITCZへの引力の強さ。 |
| `oceanDeflectLat` | ITCZからの最大許容拡散距離。Pass 2 (EC) においては、この値の半分が目標分離幅として使用されます。 |
| `oceanEcPatternForce` | Pass 2 (EC) における、目標緯度への引力の強さ。 |
| `oceanEcPolewardDrift` | EC発生時の初期極方向初速。 |

---

## 5. 可視化・色付けロジック (Visualization)

シミュレーション結果の可視化において、海流の性質を直感的に伝えるため、以下の色分けルールを採用しています。

### 色相 (Hue) - 熱輸送の方向
*   **赤色 (Red)**: **ITCZから離れる流れ (Leaving)**。熱帯の熱を極方向へ運ぶ「暖流」を表現します。
*   **青色 (Blue)**: **ITCZへ近づく流れ (Approaching)**。高緯度または深層から熱帯へ戻る「寒流」や「還流」を表現します。

### 彩度・明度 (Intensity) - 緯度方向の勢い
海流が東西方向（Zonal）に流れているか、南北方向（Meridional）に流れているかを、色の鮮やかさで表現します。

*   **黒色 (Black)**: **角度が浅い（東西流）**。ITCZに対して平行に近い、緩やかなアプローチ。
*   **鮮やかな色 (Vivid)**: **角度が急（南北流）**。ITCZに対して垂直に近い、急激なアプローチまたは離脱。

`intensity = (abs(vy) / max_drift)^2` の非線形カーブを用いることで、わずかな南北移動は黒く、強い南北移動のみを鮮やかに表示し、主要な熱輸送パスを強調します。
