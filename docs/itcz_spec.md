# 汎用惑星におけるITCZ決定アルゴリズム 実装仕様書

**高度補正・海洋規模対応版**

本ドキュメントは、任意の惑星パラメータ（地軸傾斜、自転・公転、気圧、地形、標高）に基づき、夏半球におけるITCZ（熱帯収束帯）の緯度座標を算出する手順を定義する。

---

## 0. 物理モデル調整値（定数定義）

アルゴリズムの挙動を調整するための「マジックナンバー」を以下に定義する。これらは外部設定ファイル等で調整可能にすることを推奨する。

| 変数名 | 推奨値 | 単位 | 説明 |
|:-------|-------:|:----:|:-----|
| `C_SATURATION_DIST` | 2000.0 | km | **熱飽和距離**。海岸線からこの距離以上離れると、気候特性が飽和する（陸側・海側とも共通）。 |
| `C_ALTITUDE_LIMIT` | 5.0 | km | **熱的影響限界高度**。これ以上の標高では、陸地であっても「熱源」として機能しない。 |
| `C_REF_PRESSURE` | 1013.0 | hPa | **基準気圧**（地球）。熱容量の比較基準。 |
| `C_REF_YEAR` | 8760.0 | h | **基準公転周期**（地球の1年）。季節による加熱時間の比較基準。 |
| `C_REF_DAY` | 24.0 | h | **基準自転周期**（地球の1日）。コリオリ力と気象スケールの比較基準。 |
| `C_INERTIA_EXP` | 0.5 | - | **熱慣性指数の重み**。気圧や年長の差がどれだけ強く影響するか（0.5 = 平方根で評価）。 |
| `C_BASE_SEA_RATIO` | 0.2 | - | **海洋上の移動係数基準**。地球環境の海上で、ITCZが地軸傾斜の何割まで移動するか。 |
| `C_BASE_LAND_RATIO` | 0.9 | - | **陸上の移動係数基準**。地球環境の陸上で、ITCZが地軸傾斜の何割まで移動するか。 |
| `C_KERNEL_ANGLE` | 15.0 | deg | **基準参照角度**。地球の自転速度において、熱的影響を平均化する経度方向の範囲（片側）。 |
| `C_KERNEL_MAX` | 60.0 | deg | **参照角度の上限**。自転が極端に遅い場合でも、全半球平均にならないためのキャップ。 |

---

## 1. 算出アルゴリズム

### 1.1 入力データの準備

以下のデータをグリッドマップ（W × H）およびスカラー値として用意する。

**MapData(lon, lat)** : 各グリッドの「海岸線からの符号付き距離 [km]」。

- 陸地 = **正の値**（海岸線から内陸方向への距離）
- 海岸線 = **0**
- 海洋 = **負の値**（海岸線から沖合方向への距離）

```
例：
  太平洋中心部  → -3000 km（大外洋）
  沿岸海域      → -100 km
  海岸線        → 0 km
  沿岸陸地      → +100 km
  大陸内部      → +2000 km（内陸深部）
```

**Altitude(lon, lat)** : 各グリッドの「標高 [km]」。

- 海面 = 0
- 陸地 = 正の値
- （盆地などでマイナスがある場合は0として扱う）

**PlanetParams** :

- ε : 地軸傾斜角 [deg] (0.0 ～ 90.0)
- P_rot : 自転周期 [h]
- P_orb : 公転周期 [h]
- P_atm : 地表気圧 [hPa]

---

### 1.2 影響マップ（HeatMap）の生成

「海岸線からの符号付き距離」と「標高ペナルティ」を組み合わせ、各地点のITCZ吸引力を **-1.0〜+1.0** の範囲で表現する。

任意の地点 (x, y) において：

**1. 距離スコア（S_dist）**: 符号付き正規化

```
S_dist = clamp( MapData(x, y) / C_SATURATION_DIST, -1.0, +1.0 )
```

- 大外洋 → -1.0
- 海岸線 → 0.0
- 内陸深部 → +1.0

**2. 高度ペナルティ係数（P_alt）**: 陸地のみに適用

```
if MapData(x, y) > 0:  // 陸地の場合
    P_alt = max( 0.0, 1.0 - Altitude(x, y) / C_ALTITUDE_LIMIT )
else:                   // 海洋の場合
    P_alt = 1.0         // ペナルティなし
```

**3. 最終ヒートマップ値**:

```
HeatMap(x, y) = S_dist × P_alt
```

**解説**:

| 地点タイプ | S_dist | P_alt | HeatMap | 意味 |
|:-----------|-------:|------:|--------:|:-----|
| 大外洋（太平洋中心） | -1.0 | 1.0 | **-1.0** | 強く赤道に留める |
| 沿岸海域 | -0.2 | 1.0 | **-0.2** | やや海洋的 |
| 内海（地中海等） | -0.1 | 1.0 | **-0.1** | 陸に近い海洋 |
| 沿岸平地 | +0.2 | 1.0 | **+0.2** | やや大陸的 |
| 内陸平地 | +1.0 | 1.0 | **+1.0** | 強く極方向へ引く |
| 内陸高山（5km） | +1.0 | 0.0 | **0.0** | 熱源として機能しない |
| 内陸高原（2.5km） | +1.0 | 0.5 | **+0.5** | 中程度の吸引力 |

---

### 1.3 惑星熱反応係数（Planetary Coefficients）の算出

地形とは無関係に、その惑星全体の「熱の動きやすさ」を決める係数を算出する。

まず、惑星固有の反応係数 M_planet を求める：

```
M_planet = (P_orb / C_REF_YEAR)^C_INERTIA_EXP × (C_REF_PRESSURE / P_atm)^C_INERTIA_EXP
```

※ M_planet は上限を 1.5 程度、下限を 0.05 程度にクリッピングすることを推奨（極端な入力値対策）。

次に、海と陸それぞれの最大到達係数を決定する：

```
K_sea  = min( C_BASE_SEA_RATIO  × M_planet, 0.8 )
K_land = min( C_BASE_LAND_RATIO × M_planet, 1.0 )
```

---

### 1.4 平滑化カーネルサイズ（R）の決定

自転速度に基づき、周辺環境を参照する範囲（経度方向の角度）を決定する。

```
R = min( C_KERNEL_ANGLE × (P_rot / C_REF_DAY), C_KERNEL_MAX )
```

---

### 1.5 実効陸地比率（L_eff）の算出

ターゲットとなる経度 λ ごとに、周辺のHeatMap値を加重平均で算出する。高緯度歪みを防ぐため、cos(lat) による面積重み付けを行う。

各経度 λ (0...360) について：

**1. 参照範囲 S の定義**:

- 経度範囲：[λ - R, λ + R]（周期境界を考慮すること）
- 緯度範囲：[0, ε]（赤道から回帰線まで）

**2. 加重平均の計算**:

```
L_eff(λ) = Σ( HeatMap(x, y) × cos(lat_y) ) / Σ( cos(lat_y) )   [for (x, y) ∈ S]
```

※ L_eff の値域は **-1.0〜+1.0** となる。

---

### 1.6 ITCZ緯度の決定

L_eff を正規化し、最終的な緯度 φ_ITCZ(λ) を線形補間により決定する。

**1. 正規化**:

```
t = (L_eff(λ) + 1.0) / 2.0
```

- L_eff = -1.0（完全な外洋）→ t = 0.0
- L_eff = +1.0（完全な内陸）→ t = 1.0

**2. 緯度の算出**:

```
φ_ITCZ(λ) = ε × [ (1.0 - t) × K_sea + t × K_land ]
```

**注記**:

- 計算結果は「夏半球側の緯度（絶対値）」である。
- 7月（北半球夏）のマップを作る場合は、北緯 φ_ITCZ にプロット。
- 1月（南半球夏）のマップを作る場合は、南緯 φ_ITCZ にプロット。

---

### 1.7 補間と出力

計算された離散的な点群 (λ, φ_ITCZ) を、スプライン曲線等で滑らかに接続し、最終的なITCZラインとして出力する。

---

― 以上 ―